---
title: "Facegen"
weight: 2
type: docs
description: >
  Creating facegen for vanilla NPCs and mods.
---

## About Facegen

Among the most common "bugs" in Skyrim is the dreaded "black face" which is simply mismatched facegen. NPC heads - specifically tintmasks like dirt, warpaints, makeup - are defined in their records (in the official master files and sometimes other mods that change them) but there must be matching textures and meshes present as well. The "black face" occurs when the facegen files (aforementioned textures and meshes) do not match the NPC record. The facegen files are generated by the Creation Kit.

TPF is using a number of mods to improve NPC appearance. However, by default many of these mods will only affect the player character and facegen must be regenerated with those mods so that they can apply to NPCs as well. In this step we will regenerate facegen not only for all vanilla NPCs but also for NPCs added by certain mods for consistent and high quality facegen across the board.

The process of creating facegen was significantly simplified by **Nuukem's Creation Kit Fixes** and **VictorF's zEdit script**.

## Creation Kit Tweak

By default the Creation Kit will generate facetint textures with a 512x512 resolution. Thanks to CK Fixes we can easily increase the resolution for higher quality output.

- Navigate to your **root** folder.
- Double-click **skyrim64_test.ini**.
- Scroll to **Line 31** and change the line to `TintMaskResolution=1024`.
- Save the file and close.

## NPCs Plugin

The official master files have a large amount of NPC records, not all of which need facegen. For example, we don't need to regenerate facegen for children, NPCs that have templates (use facegen from other records), or simply creatures. Thankfully, we can use zEdit and a code snippet by VictorF to filter out relevant records and copy them to a separate plugin. We will also use it to filter out NPC records with facegen from those mods that add new NPCs at the same time.

- Run **zEdit** through Mod Organizer 2.
- The regular **zEdit** mode and **Skyrim SE** should be selected by default. Click **Start Session**.
- Click on any plugin in the **Load Order** window and press CTRL+A to select all.
- Right-click the highlighted plugins and select **Uncheck selected**.
- Now check only the following plugins:
  - Skyrim.esm
  - Update.esm
  - Dawnguard.esm
  - HearthFires.esm
  - Dragonborn.esm
  - Unofficial Skyrim Special Edition Patch.esp
  - DIVERSE SKYRIM.esp
  - CFTO.esp
  - Immersive Patrols II.esp
  - OCW_Obscure's_CollegeofWinterhold.esp
  - ICNs_ImmersiveCollegeNPCs.esp
- Click **OK** to load the selected plugins.

### Create Plugin

- Proceed once zEdit has loaded the selected plugins (will only take a few second).
- Right-click anywhere in the left pane and select **Automate**.
- Copy the snippet from below and paste it into the window:

```java
const filename = 'NPCsWithFaces.esp';
let file = xelib.FileByName(filename);
if(file === 0) file = xelib.AddFile(filename);
xelib.AddAllMasters(file);

let races = xelib.GetRecords(0, 'RACE', true)
    .filter(rec => xelib.IsWinningOverride(rec))
    .filter(rec => xelib.GetFlag(rec, 'DATA\\Flags', 'FaceGen Head') && !xelib.GetFlag(rec, 'DATA\\Flags', 'Child'))
    .map(rec => xelib.EditorID(rec));
let npcs = xelib.GetRecords(0, 'NPC_', true)
    .filter(rec => xelib.IsWinningOverride(rec))
    .filter(rec => 
        (!xelib.HasElement(rec, 'TPLT')
         || !xelib.GetFlag(rec, 'ACBS\\Template Flags', 'Use Traits'))
         && races.includes(xelib.GetRefEditorID(rec, 'RNAM')));
npcs.forEach(rec => xelib.CopyElement(rec, file));
xelib.CleanMasters(file);
```

- In the **Script** line, rename **New Script.js** to **NPCsWithFaces.js**.
- Click the **Save** button to save the snippet.
- Click **OK** to run the script.

![zEdit NPC Script](/Pictures/skyrim-se/initial-setup/zedit-npc-script.png)

### Output

- When the plugin has been generated, zEdit will return `Script completed` and you can close the tool.
- Click **Save** when asked (NPCsWithFaces.esp should be checked).
- In Mod Organizer 2, scroll to the bottom and double-click the ***Overwrite***.
- Delete the (empty) **zEdit Backups** folder if it's there, then close the ***Overwrite*** window.
- Right-click the ***Overview*** and select **Create Mod**.
- Enter **NPCs With Faces** as the name and click **OK**.
- Move the new mod directly below the **PATCHER OUTPUT** separator and activate it.
- Load order doesn't matter for the plugin, leave it at the bottom.

> Make sure that the Overwrite is completely empty at this point.

## Regenerating Facegen

Now we get to the heart of the matter: Rebuilding facegen for all NPCs, vanilla and mod-added. Facegen is generated in the Creation Kit and thanks to [Creation Kit Fixes](https://www.nexusmods.com/skyrimspecialedition/mods/20061) it's fast and easy.

- Run the **Creation Kit** through Mod Organizer 2.
- Go to **File** >> **Data** and scroll all the way to the bottom of the load order in the left pane.
- Select the **NPCsWithFaces.esp** and click the **Set as Active File** button, then click **OK** to load the plugin.

![Open Plugin in CK](/Pictures/skyrim-se/finalisation/load-plugin-ck.png)

### Filter NPC Records

Proceed when the CK has loaded up the plugin and its dependencies.

- In the list of record types on the left, expand **Actors** and select **Actor**.
- Check the box for **Show only active (*) forms**.

> The option to filter for active forms is added by CK Fixes and it's ingenious. Checking it will make it so only records touched by the current active plugin are displayed which means we only see NPC records filtered out earlier in zEdit into the NPCsWithFaces plugin.

![Filter NPC Records](/Pictures/skyrim-se/finalisation/filter-npc-records.png)

### Export Facegen

- The records should be sorted alphabetically (click the **Editor ID** column if they aren't).
- Click the **Abelone** NPC near the top (we're skipping the dummy NPCs).
- Scroll down all the way to the bottom. Hold SHIFT and click the final NPC **Zaynabi** to highlight all records in between.
- Press **CTRL + F4** to export facegen and click **Yes** to confirm.
- You can check the progress in the **Log** window. Ignore the warnings.
- Exporting facegen for all NPCs will take a few minutes. Wait until a window pops up that simply says **Done**.
- Click **OK** and close the Creation Kit.

![Export Facegen](/Pictures/skyrim-se/finalisation/ck-export-facegen.png)

## Optimising Facegen

At this time you will have about 17GB of loose facegen files in your ***Overwrite*** folder. Before we slim those down, let's clean up a bit:

- Right-click your ***Overwrite*** folder and select **Create mod**.
- Enter **Facegen Output** as the name and click **OK**.
- Move the mod below **NPCs With Faces** in your mod order and activate it.
- Deactive the **NPCs With Faces** mod (it's only needed for regenerating the facegen files themselves).

### Cathedral Assets Optimizer

Using CAO we will compress the facegen files and pack them neatly into BSAs. This will bring down the total file size from 17GB to around 2GB.

- Run **Cathedral Assets Optimizer** (outside of Mod Organizer 2).
- Select the **SSE - Optimise Facegen** profile.
- Click **Open Directory** and navigate to your **Facegen Output** mod folder.
- Click **Run** and wait for CAO to process all files.
- This will some time (about 6 minutes for me). The CAO log will eventually return `[INFO] Process completed`. Close CAO.
- Return to Mod Organizer 2 and press F5 to refresh. Two new plugins will appear at the bottom of your load order.
- Make sure both **Facegen Output.esp** and **Facegen Output0.esp** are checked so they can load the BSAs containing the facegen files.